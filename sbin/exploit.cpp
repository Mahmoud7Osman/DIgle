#include <stdlib.h>

#include <iostream>
#include <cstring>

#include <sys/socket.h>
#include <arpa/inet.h>
#include <netinet/in.h>

#include <wait.h>

#include "../lib/include/fatal.h"
#include "../lib/include/done.h"



int reverse(char *ip, char *port);
int request(char *ip, char *port);

int main(int argc, char* argv[]){
        if(argc<3)return 1;
	if (strcmp(argv[1], "connect")==0){
		if (WEXITSTATUS(request(argv[2], argv[3]))==1)
			return 2;
	}
	if (strcmp(argv[1], "listen")==0){
                if (WEXITSTATUS(reverse(argv[2], argv[3]))==1)
			return 4;
	}
	return 0;
}

int reverse(char *ip, char *port){
	char *command=(char*)malloc(strlen(ip)+strlen(port)+7);
	sprintf (command, "nc -l %s %s", ip,port);
        int ret=system(command);
        free(command);
        return ret;
}


int request(char *ip, char *port){
        char *command=(char*)malloc(strlen(ip)+strlen(port)+4);
        sprintf (command, "nc %s %s", ip,port);
        int ret=system(command);
       	free(command);
	return ret;
}


